<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Harry Crotter</title>
        <!-- <script src="./aframe.js"></script> -->
        <script src="https://aframe.io/releases/0.5.0/aframe.min.js"></script>
    </head>
    <body>
        <a-scene move-click >
                <a-assets>
                    <img id="wallTexture" src="https://cdn.glitch.com/551b12a4-09a1-462a-8f00-e861c3e82645%2Fdimitri-iakymuk-107955-unsplash.jpg?1541685028879%22%3E" />
                    <img id="groundTexture" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRrjnnshR5k8UWlbPeXt3iNGTNmagNqH-fF1zCvsdEn8Nh2c0yu%22%3E" />
                    <img id="spell" src="https://a.wattpad.com/cover/7668857-288-k560123.jpg%22%3E" />
                    <img id="cup" src="https://cdn.glitch.com/551b12a4-09a1-462a-8f00-e861c3e82645%2Funtitled.147.jpg?1541677826300%22%3E"/>
                    <a-asset-item id="cupObj" src="https://cdn.glitch.com/551b12a4-09a1-462a-8f00-e861c3e82645%2Fcup.obj?1541677534435%22%3E"></a-asset-item>
                </a-assets>
            <a-camera>
                <a-cursor>
                </a-cursor>
            </a-camera>
        </a-scene>
        <script>
            const request = new XMLHttpRequest()
            request.open('GET', 'map.txt', false)
            request.send()
            const map = request.responseText.split('\n')

            // const requestConfig = new XMLHttpRequest()
            // requestConfig.open('GET', 'config.json', false)
            // requestConfig.send()
            // const config = JSON.parse(requestConfig.responseText)
            // console.log(config)

            const scene = document.querySelector('a-scene')
            const camera = document.querySelector('a-camera')

            let mousedownID = -1
            function mousedown(event) {
            if (mousedownID==-1)
                mousedownID = setInterval(whilemousedown, 50 /*execute every 100ms*/)
            }

            function mouseup(event) {
                if(mousedownID!=-1) {
                    clearInterval(mousedownID)
                    mousedownID=-1
                }
            }

            function whilemousedown() {
                const currentPos = camera.getAttribute('position')
                const currentRot = camera.getAttribute('rotation')
                const futurePos = {
                    x: currentPos.x + 0.2 * Math.sin((currentRot.y - 180) * Math.PI / 180.0),
                    y: currentPos.y,
                    z: currentPos.z + 0.2 * Math.cos((currentRot.y -180) * Math.PI / 180.0),
                }

                nextMapContent = map[Math.round(futurePos.x)][Math.round(futurePos.z)]
                currentMapContent = map[Math.round(currentPos.x)][Math.round(currentPos.z)]

                if (nextMapContent == '#') {
                    return false
                }

                switch (currentMapContent) {
                    case 'x':
                        startNewGame()
                        return false
                    case '1':
                        startNewGame()
                        return false
                }


                camera.setAttribute('position', {
                    x: currentPos.x + 0.1 * Math.sin((currentRot.y - 180) * Math.PI / 180.0),
                    y: currentPos.y,
                    z: currentPos.z + 0.1 * Math.cos((currentRot.y -180) * Math.PI / 180.0),
                })
            }

            scene.addEventListener("mousedown", mousedown)
            scene.addEventListener("touchstart", mousedown)
            scene.addEventListener("mouseup", mouseup)
            scene.addEventListener("touchend", mouseup)
            scene.addEventListener("mouseout", mouseup)

            function startNewGame(first = false) {
                const startingPos = startingAllowed[Math.floor(Math.random()*startingAllowed.length)];
                camera.setAttribute('position', startingPos[0] + (first ? ' 0 ' : ' 1 ')  + startingPos[1])
            }

            function createWall(type, i, j) {

                const wall = document.createElement('a-box')

                if(type == 'o' || type == 'g') {
                    const anim = document.createElement('a-animation')
                    anim.setAttribute('dur', '2000')
                    anim.setAttribute('attribute', 'position')
                    anim.setAttribute('id', 'anim' + i + '-' + j)
                    anim.setAttribute('repeat', 'indefinite')
                    anim.setAttribute('direction', 'alternate')
                    anim.setAttribute('delay', '2000')



                    if (type == 'g') {
                        anim.setAttribute('from', i + ' -2 ' + j)
                        anim.setAttribute('to', i + ' 2 ' + j)
                    } else {
                        anim.setAttribute('from', i + ' 2 ' + j)
                        anim.setAttribute('to', i + ' -2 ' + j)
                    }
                    wall.appendChild(anim)
                }

                if(type == 'g') {
                    wall.setAttribute('position', i + ' -2 ' + j)
                } else {
                    wall.setAttribute('position', i + ' 2 ' + j)
                }

                wall.setAttribute('height', 4)
                wall.setAttribute('src', '#wallTexture')

                scene.appendChild(wall)
            }

            const startingAllowed = []

            for (i in map) {
                map[i] = map[i].split('')
                for(j in map[i]) {
                    const elem = document.createElement('a-box')
                    elem.setAttribute('height', 0.1)
                    elem.setAttribute('position', i + ' 0.1 ' + j)
                    switch (map[i][j]) {
                        case "1":
                            elem.setAttribute('src', '#cup')
                            scene.appendChild(elem)
                            break
                        case "x":
                            elem.setAttribute('color', 'yellow')
                            scene.appendChild(elem)
                            break
                        case "0":
                            startingAllowed.push([i, j])
                            break
                        case 'o':
                        case '#':
                        case 'g':
                            createWall(map[i][j], i, j)
                            break
                    }
                }
            }
            const ground = document.createElement('a-box')
            ground.setAttribute('src', 'black')
            ground.setAttribute('height', 0.1)
            ground.setAttribute('position', ((map.length - 1) / 2 - 0.5) + ' 0 ' + ((map.length - 1) / 2 - 0.5) )
            ground.setAttribute('width', (map.length - 1))
            ground.setAttribute('depth', (map.length - 1))

            scene.appendChild(ground)
            startNewGame(true)
        </script>
    </body>
</html>
